# API Contracts — Marketplace (ut-market-place)

Part: `marketplace`  
Repo: `~/repos/unitill/ut-market-place`  
Entry point: `cmd/marketplace/main.go`

Marketplace exposes:
- **gRPC services** (registered in `cmd/marketplace/main.go`)
- **REST gateway** mounted under `/api/` via gRPC-Gateway (`internal/httpapi/router/router.go`)
- **UI** under `/ui/`
- **Root-level operational and documentation endpoints**

## Root / UI / Discovery (HTTP)

From `internal/httpapi/router/router.go` and handlers:

- `/` → redirects to `/ui/`
- `/ui/` → UI server (templates)
- `/healthz` → health handler
- `/.well-known/marketplace-endpoints.json` → discovery document (POS uses this)

### API Documentation (HTTP)

From `internal/httpapi/handlers/apidocs.go`:
- `/openapi.yaml`
- `/docs` (Swagger UI)
- `/redoc` (ReDoc UI)

## REST API Surface

### gRPC-Gateway mounted under `/api/`

From `cmd/marketplace/main.go` registrars:
- Catalog service (REST gateway)
- Auth service (REST gateway)
- Download service (REST gateway)

Exact REST routes are generated by gRPC-Gateway from `pkg/contracts/marketplace/v1` and documented in:
- `docs/openapi.yaml`
- `docs/api-reference.md`

### Direct HTTP endpoints (not via gRPC-Gateway)

From `internal/httpapi/handlers/downloads.go`:
- `/api/v1/downloads/issue-token`
- `/api/v1/downloads/resume-capability`
- `/api/v1/downloads/resume`
- `/api/v1/downloads/status`
- `/api/v1/downloads/artifact/` (artifact streaming/download)

## gRPC Services

Registered in `cmd/marketplace/main.go` (server side) and via gateway:
- `CatalogService`
- `AuthService`
- `DownloadService`

## Auth / Security

- JWT-based auth is initialized in `cmd/marketplace/main.go` using `AUTH_JWT_SECRET` (or generated for dev).
- Middleware is applied in `internal/httpapi/router/router.go` with a skipper for:
  - `/healthz`
  - `/.well-known/marketplace-endpoints.json`
  - `/ui/`
- Security headers and basic rate limiting are applied (`Content-Security-Policy`, HSTS, etc.).

## Notes / Gaps

- Plugin publish/upload endpoints should be confirmed against spec/tasks in `specs/001-plugin-marketplace/`.
- For POS plugin install MVP, ensure the REST gateway covers install intent/status or add explicit endpoints (see docs in `docs/marketplace/api.md` in the docs repo).

